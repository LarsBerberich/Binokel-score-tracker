{% extends "base.html" %}
{% load django_bootstrap5 %}
{% load score_tracker_tags %}

{% block title %}New Round - {{ game.name }} - Binokel Score Tracker{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">Add Round for {{ game.name }}</h4>
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    
                    <div class="mb-4">
                        <h5>Game Maker Information</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {% bootstrap_field form.game_maker %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {% bootstrap_field form.bid_amount %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3 form-check">
                                    {% bootstrap_field form.is_success %}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3 form-check">
                                    {% bootstrap_field form.is_abgehen %}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3 form-check">
                                    {% bootstrap_field form.is_durch %}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3 form-check">
                                    {% bootstrap_field form.is_doppelt_abgehen %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <h5>Game Maker Points</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {% bootstrap_field form.meld_points %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {% bootstrap_field form.trick_points %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <h5>Other Players' Points</h5>
                        {% for player in game.players.all %}
                                <div class="card mb-3">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">{{ player.name }}</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                {% with field_name="player_"|add:player.id|add:"_meld_points" %}
                                                    {% with field=form|get_field_by_name:field_name %}
                                                        {% if field %}
                                                            {% bootstrap_field field %}
                                                        {% endif %}
                                                    {% endwith %}
                                                {% endwith %}
                                            </div>
                                            <div class="col-md-6">
                                                {% with field_name="player_"|add:player.id|add:"_trick_points" %}
                                                    {% with field=form|get_field_by_name:field_name %}
                                                        {% if field %}
                                                            {% bootstrap_field field %}
                                                        {% endif %}
                                                    {% endwith %}
                                                {% endwith %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                        {% endfor %}
                    </div>
                    
                    <div class="mb-3">
                        <h5>Last Trick</h5>
                        {% bootstrap_field form.last_trick_winner %}
                    </div>
                    
                    <div class="d-flex justify-content-end">
                        <a href="{% url 'score_tracker:game_detail' game.id %}" class="btn btn-outline-secondary me-2">Cancel</a>
                        <button type="submit" class="btn btn-primary">Save Round</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get checkbox elements
    const isAbgehenCheckbox = document.getElementById('id_is_abgehen');
    const isDurchCheckbox = document.getElementById('id_is_durch');
    const isSuccessCheckbox = document.getElementById('id_is_success');
    const isDoppeltAbgehenCheckbox = document.getElementById('id_is_doppelt_abgehen');
    
    // Get point input elements
    const meldPointsInput = document.getElementById('id_meld_points');
    const trickPointsInput = document.getElementById('id_trick_points');
    const bidAmountInput = document.getElementById('id_bid_amount');
    
    // Track whether user has manually changed status checkboxes
    let userModifiedSuccess = false;
    let userModifiedDoppeltAbgehen = false;
    
    function getAllPlayerPointInputs() {
        const inputs = [];
        // Find all player point inputs dynamically
        const allInputs = document.querySelectorAll('input[type="number"]');
        allInputs.forEach(input => {
            if (input.name && (input.name.includes('_meld_points') || input.name.includes('_trick_points')) && 
                input.name.startsWith('player_')) {
                inputs.push(input);
            }
        });
        return inputs;
    }
    
    function areAllPointsEntered() {
        // Check if game maker's points are entered
        if (!meldPointsInput.value || !trickPointsInput.value) {
            return false;
        }
        
        // Check if all other players' points are entered
        const playerInputs = getAllPlayerPointInputs();
        for (let input of playerInputs) {
            if (!input.value) {
                return false;
            }
        }
        
        return true;
    }
    
    function calculateAutomaticStatus() {
        if (!areAllPointsEntered() || !bidAmountInput.value) {
            return;
        }
        
        const meldPoints = parseInt(meldPointsInput.value) || 0;
        const trickPoints = parseInt(trickPointsInput.value) || 0;
        const bidAmount = parseInt(bidAmountInput.value) || 0;
        const totalPoints = meldPoints + trickPoints;
        
        // Only auto-calculate if user hasn't manually modified these fields
        if (!userModifiedSuccess && !userModifiedDoppeltAbgehen) {
            if (totalPoints >= bidAmount) {
                // Game maker reached or exceeded bid amount - success
                isSuccessCheckbox.checked = true;
                isDoppeltAbgehenCheckbox.checked = false;
            } else {
                // Game maker didn't reach bid amount - doppelt abgehen
                isSuccessCheckbox.checked = false;
                isDoppeltAbgehenCheckbox.checked = true;
            }
            
            // Update form state after auto-calculation
            updateFormState();
        }
    }
    
    function updateFormState() {
        // Reset all disabled states first
        isAbgehenCheckbox.disabled = false;
        isDurchCheckbox.disabled = false;
        isSuccessCheckbox.disabled = false;
        isDoppeltAbgehenCheckbox.disabled = false;
        
        // If "Durch" is selected
        if (isDurchCheckbox.checked) {
            isAbgehenCheckbox.checked = false;
            isAbgehenCheckbox.disabled = true;
            isSuccessCheckbox.disabled = true;
            isDoppeltAbgehenCheckbox.disabled = true;
        } 
        // If "Abgehen" is selected
        else if (isAbgehenCheckbox.checked) {
            isDurchCheckbox.checked = false;
            isDurchCheckbox.disabled = true;
            isSuccessCheckbox.checked = false;
            isSuccessCheckbox.disabled = true;
            isDoppeltAbgehenCheckbox.checked = false;
            isDoppeltAbgehenCheckbox.disabled = true;
        }
        // If "Success" is selected
        else if (isSuccessCheckbox.checked) {
            isDoppeltAbgehenCheckbox.checked = false;
            isDoppeltAbgehenCheckbox.disabled = true;
        }
        // If "Doppelt Abgehen" is selected
        else if (isDoppeltAbgehenCheckbox.checked) {
            isSuccessCheckbox.checked = false;
            isSuccessCheckbox.disabled = true;
        }
    }
    
    // Add event listeners for manual checkbox changes
    isAbgehenCheckbox.addEventListener('change', function() {
        updateFormState();
    });
    
    isDurchCheckbox.addEventListener('change', function() {
        updateFormState();
    });
    
    isSuccessCheckbox.addEventListener('change', function() {
        userModifiedSuccess = true;
        updateFormState();
    });
    
    isDoppeltAbgehenCheckbox.addEventListener('change', function() {
        userModifiedDoppeltAbgehen = true;
        updateFormState();
    });
    
    // Add event listeners for point inputs to trigger automatic calculation
    [meldPointsInput, trickPointsInput, bidAmountInput].forEach(input => {
        if (input) {
            input.addEventListener('input', calculateAutomaticStatus);
        }
    });
    
    // Also listen to all player point inputs
    getAllPlayerPointInputs().forEach(input => {
        input.addEventListener('input', calculateAutomaticStatus);
    });
    
    // Run once at startup
    updateFormState();
    calculateAutomaticStatus();
});
</script>
{% endblock %}